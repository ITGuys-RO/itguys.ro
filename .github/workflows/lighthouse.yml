name: Lighthouse Report

on:
  schedule:
    - cron: "0 8 * * *" # 8AM UTC daily
  workflow_dispatch: # Allow manual triggers

jobs:
  lighthouse:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Warm up sites
        run: |
          echo "Warming up Cloudflare Workers..."
          for url in https://itguys.ro/ https://itguys.ro/about https://itguys.ro/services https://itguys.ro/portfolio https://itguys.ro/contact; do
            curl -s -o /dev/null -w "%{url_effective} - %{http_code}\n" "$url"
            sleep 1
          done
          echo "Waiting for workers to stabilize..."
          sleep 5
          # Second warm-up pass
          for url in https://itguys.ro/ https://itguys.ro/about https://itguys.ro/services https://itguys.ro/portfolio https://itguys.ro/contact; do
            curl -s -o /dev/null "$url"
          done

      - name: Run Lighthouse
        id: lighthouse
        uses: treosh/lighthouse-ci-action@v12
        with:
          urls: |
            https://itguys.ro/
            https://itguys.ro/about
            https://itguys.ro/services
            https://itguys.ro/portfolio
            https://itguys.ro/contact
          runs: 3 # Run 3 times per URL, use median
          uploadArtifacts: true
          temporaryPublicStorage: true
          configPath: .github/lighthouse/lighthouserc.json

      - name: Check Scores and Create PR if Needed
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const THRESHOLD = 85; // Lower threshold for CI environment
            const resultsPath = '.lighthouseci';

            if (!fs.existsSync(resultsPath)) {
              console.log('No Lighthouse results found');
              return;
            }

            const files = fs.readdirSync(resultsPath).filter(f => f.endsWith('.json') && f.startsWith('lhr-'));
            const date = new Date().toISOString().split('T')[0];

            // Group results by URL and calculate medians
            const resultsByUrl = {};
            for (const file of files) {
              const data = JSON.parse(fs.readFileSync(path.join(resultsPath, file), 'utf8'));
              const urlPath = new URL(data.finalUrl).pathname || '/';

              if (!resultsByUrl[urlPath]) {
                resultsByUrl[urlPath] = [];
              }

              resultsByUrl[urlPath].push({
                performance: data.categories.performance.score * 100,
                accessibility: data.categories.accessibility.score * 100,
                bestPractices: data.categories['best-practices'].score * 100,
                seo: data.categories.seo.score * 100
              });
            }

            // Calculate median for each metric
            function median(arr) {
              const sorted = [...arr].sort((a, b) => a - b);
              const mid = Math.floor(sorted.length / 2);
              return sorted.length % 2 ? sorted[mid] : (sorted[mid - 1] + sorted[mid]) / 2;
            }

            let summary = `## Lighthouse Report - ${date}\n\n`;
            summary += `> Using **median scores** from 3 runs per page with **desktop preset**\n`;
            summary += `> CI threshold: ${THRESHOLD}% (CI scores are typically lower than local Chrome)\n\n`;
            let issues = [];

            for (const [urlPath, runs] of Object.entries(resultsByUrl)) {
              const pageName = urlPath === '/' ? 'Home' : urlPath;

              const scores = {
                'Performance': Math.round(median(runs.map(r => r.performance))),
                'Accessibility': Math.round(median(runs.map(r => r.accessibility))),
                'Best Practices': Math.round(median(runs.map(r => r.bestPractices))),
                'SEO': Math.round(median(runs.map(r => r.seo)))
              };

              summary += `### ${pageName}\n`;
              summary += `| Metric | Score | Status |\n`;
              summary += `|--------|-------|--------|\n`;

              for (const [metric, score] of Object.entries(scores)) {
                const status = score >= THRESHOLD ? '‚úÖ' : '‚ö†Ô∏è';
                summary += `| ${metric} | ${score} | ${status} |\n`;

                if (score < THRESHOLD) {
                  issues.push({ page: pageName, metric, score });
                }
              }
              summary += '\n';
            }

            console.log(summary);
            core.summary.addRaw(summary).write();

            // Create PR if there are issues
            if (issues.length > 0) {
              const branchName = `lighthouse-alert/${date}`;

              // Check if branch already exists
              try {
                await github.rest.repos.getBranch({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  branch: branchName
                });
                console.log(`Branch ${branchName} already exists, skipping PR creation`);
                return;
              } catch (e) {
                // Branch doesn't exist, continue
              }

              // Create issue report file
              let reportContent = `# Lighthouse Performance Alert - ${date}\n\n`;
              reportContent += `## Summary\n\n`;
              reportContent += `The following metrics have dropped below the ${THRESHOLD}% CI threshold:\n\n`;
              reportContent += `| Page | Metric | Score |\n`;
              reportContent += `|------|--------|-------|\n`;

              for (const issue of issues) {
                reportContent += `| ${issue.page} | ${issue.metric} | ${issue.score}% |\n`;
              }

              reportContent += `\n> **Note:** CI scores are typically 10-20% lower than local Chrome DevTools due to:\n`;
              reportContent += `> - Shared GitHub Actions runner resources\n`;
              reportContent += `> - Network latency from data centers\n`;
              reportContent += `> - Cold start penalties for serverless functions\n\n`;
              reportContent += `## Required Actions\n\n`;
              reportContent += `1. Verify scores locally using Chrome DevTools Lighthouse\n`;
              reportContent += `2. If local scores are also low, investigate the cause\n`;
              reportContent += `3. Implement necessary fixes\n`;
              reportContent += `4. Update this PR with findings and fixes\n\n`;
              reportContent += `## Resources\n\n`;
              reportContent += `- [Lighthouse Documentation](https://developer.chrome.com/docs/lighthouse/)\n`;
              reportContent += `- [Web Vitals](https://web.dev/vitals/)\n`;

              // Create branch and file
              const mainRef = await github.rest.git.getRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: 'heads/master'
              });

              await github.rest.git.createRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `refs/heads/${branchName}`,
                sha: mainRef.data.object.sha
              });

              // Create/update the report file
              await github.rest.repos.createOrUpdateFileContents({
                owner: context.repo.owner,
                repo: context.repo.repo,
                path: `.github/lighthouse-reports/${date}.md`,
                message: `docs: add Lighthouse alert report for ${date}`,
                content: Buffer.from(reportContent).toString('base64'),
                branch: branchName
              });

              // Create PR
              const prBody = `## Lighthouse Performance Alert\n\n` +
                `Automated Lighthouse testing has detected scores below ${THRESHOLD}%.\n\n` +
                summary +
                `\n---\n` +
                `*This PR was automatically created by the Lighthouse CI workflow.*`;

              const pr = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `‚ö†Ô∏è Lighthouse Alert: Scores below ${THRESHOLD}% - ${date}`,
                head: branchName,
                base: 'master',
                body: prBody
              });

              console.log(`Created PR #${pr.data.number}: ${pr.data.html_url}`);
              core.summary.addRaw(`\n\nüö® **Alert PR Created:** ${pr.data.html_url}`).write();
            }

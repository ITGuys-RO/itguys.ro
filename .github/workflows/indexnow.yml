name: Submit to IndexNow

on:
  workflow_run:
    workflows: ["Deploy to Cloudflare"]
    types: [completed]

jobs:
  indexnow:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Wait for deployment to propagate
        run: sleep 15

      - name: Fetch sitemap and submit to IndexNow
        env:
          INDEXNOW_KEY: ${{ secrets.INDEXNOW_KEY }}
        run: |
          set -e

          SITEMAP_URL="https://itguys.ro/sitemap.xml"

          echo "Fetching sitemap from $SITEMAP_URL"
          curl -s "$SITEMAP_URL" -o sitemap.xml

          echo "Sitemap content (first 20 lines):"
          head -20 sitemap.xml

          echo ""
          echo "Extracting URLs..."
          grep -o '<loc>[^<]*</loc>' sitemap.xml | sed 's/<loc>//g;s/<\/loc>//g' > urls.txt

          echo "Extracted URLs:"
          cat urls.txt

          URL_COUNT=$(wc -l < urls.txt)
          echo "Found $URL_COUNT URLs"

          if [ "$URL_COUNT" -eq 0 ]; then
            echo "ERROR: No URLs found in sitemap"
            exit 1
          fi

          URL_ARRAY=$(jq -R -s -c 'split("\n") | map(select(length > 0))' < urls.txt)

          JSON_PAYLOAD=$(jq -n \
            --arg host "itguys.ro" \
            --arg key "$INDEXNOW_KEY" \
            --arg keyLocation "https://itguys.ro/${INDEXNOW_KEY}.txt" \
            --argjson urlList "$URL_ARRAY" \
            '{host: $host, key: $key, keyLocation: $keyLocation, urlList: $urlList}')

          echo "Payload:"
          echo "$JSON_PAYLOAD" | jq .

          echo "Submitting to IndexNow..."

          HTTP_CODE=$(curl -s -w "%{http_code}" -o response.txt -X POST "https://api.indexnow.org/IndexNow" \
            -H "Content-Type: application/json; charset=utf-8" \
            -d "$JSON_PAYLOAD")

          echo "Response code: $HTTP_CODE"
          if [ -s response.txt ]; then
            echo "Response body:"
            cat response.txt
          fi

          case $HTTP_CODE in
            200) echo "OK - URLs submitted successfully" ;;
            202) echo "Accepted - URLs accepted, key validation pending" ;;
            400) echo "Bad Request - Invalid format"; exit 1 ;;
            403) echo "Forbidden - Invalid key"; exit 1 ;;
            422) echo "Unprocessable Entity - Invalid URLs"; exit 1 ;;
            429) echo "Too Many Requests - Rate limited"; exit 1 ;;
            *) echo "Unexpected response code: $HTTP_CODE"; exit 1 ;;
          esac

name: Submit to IndexNow

permissions:
  contents: read

on:
  workflow_run:
    workflows: ["Deploy to Cloudflare"]
    types: [completed]

jobs:
  indexnow:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          sparse-checkout: |
            wrangler.toml.example
          sparse-checkout-cone-mode: false

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"

      - name: Install wrangler
        run: npm install -g wrangler

      - name: Generate wrangler.toml
        run: envsubst < wrangler.toml.example > wrangler.toml
        env:
          TELEGRAM_BOT_TOKEN: "unused"
          TELEGRAM_CHAT_ID: "unused"
          TURNSTILE_SECRET_KEY: "unused"
          D1_DATABASE_ID: ${{ secrets.D1_DATABASE_ID }}

      - name: Download sitemap URLs
        uses: actions/download-artifact@v7
        with:
          name: sitemap-urls
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}

      - name: Get previously submitted URLs from D1
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          wrangler d1 execute itguys-ro --remote --command "SELECT url FROM indexnow_submitted" --json | \
            jq -r '.[0].results[].url' > submitted-urls.txt 2>/dev/null || touch submitted-urls.txt

      - name: Find new URLs to submit
        id: find-new
        run: |
          echo "=== Current sitemap URLs ==="
          cat sitemap-urls.txt
          echo ""

          echo "=== Previously submitted URLs ==="
          cat submitted-urls.txt
          echo ""

          # Find URLs that haven't been submitted yet
          sort sitemap-urls.txt > sorted-current.txt
          sort submitted-urls.txt > sorted-submitted.txt
          comm -23 sorted-current.txt sorted-submitted.txt > new-urls.txt

          NEW_COUNT=$(wc -l < new-urls.txt | tr -d ' ')

          if [ "$NEW_COUNT" -eq 0 ] || [ ! -s new-urls.txt ]; then
            echo "No new URLs to submit"
            echo "has_new=false" >> $GITHUB_OUTPUT
          else
            echo "=== New URLs to submit ($NEW_COUNT) ==="
            cat new-urls.txt
            echo "has_new=true" >> $GITHUB_OUTPUT
          fi

      - name: Submit new URLs to IndexNow
        if: steps.find-new.outputs.has_new == 'true'
        id: submit
        env:
          INDEXNOW_KEY: ${{ secrets.INDEXNOW_KEY }}
        run: |
          set -e

          URL_COUNT=$(wc -l < new-urls.txt | tr -d ' ')
          echo "Submitting $URL_COUNT new URLs to IndexNow..."

          URL_ARRAY=$(jq -R -s -c 'split("\n") | map(select(length > 0))' < new-urls.txt)

          JSON_PAYLOAD=$(jq -n \
            --arg host "itguys.ro" \
            --arg key "$INDEXNOW_KEY" \
            --arg keyLocation "https://itguys.ro/${INDEXNOW_KEY}.txt" \
            --argjson urlList "$URL_ARRAY" \
            '{host: $host, key: $key, keyLocation: $keyLocation, urlList: $urlList}')

          echo "Payload:"
          echo "$JSON_PAYLOAD" | jq .

          HTTP_CODE=$(curl -s -w "%{http_code}" -o response.txt -X POST "https://api.indexnow.org/IndexNow" \
            -H "Content-Type: application/json; charset=utf-8" \
            -d "$JSON_PAYLOAD")

          echo "Response code: $HTTP_CODE"
          if [ -s response.txt ]; then
            echo "Response body:"
            cat response.txt
          fi

          case $HTTP_CODE in
            200|202)
              echo "Success - URLs submitted"
              echo "success=true" >> $GITHUB_OUTPUT
              ;;
            400) echo "Bad Request - Invalid format"; exit 1 ;;
            403) echo "Forbidden - Invalid key"; exit 1 ;;
            422) echo "Unprocessable Entity - Invalid URLs"; exit 1 ;;
            429) echo "Too Many Requests - Rate limited"; exit 1 ;;
            *) echo "Unexpected response code: $HTTP_CODE"; exit 1 ;;
          esac

      - name: Store submitted URLs in D1
        if: steps.find-new.outputs.has_new == 'true' && steps.submit.outputs.success == 'true'
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          # Insert each URL into D1
          while IFS= read -r url; do
            if [ -n "$url" ]; then
              echo "Storing: $url"
              wrangler d1 execute itguys-ro --remote --command "INSERT OR IGNORE INTO indexnow_submitted (url) VALUES ('$url')"
            fi
          done < new-urls.txt
          echo "All URLs stored in D1"
